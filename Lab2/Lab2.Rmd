---
title: "Lab_test_2"
author: "Блинов И И"
date: "01 12 2020"
output: word_document
---

```{r setup, include=FALSE}
library(Hmisc)
library(knitr)
library(corrplot)
library('stats')

#счётчик для таблиц
table.num <- 1

#счётчик для рисунков
pic.num <- 1

```
```{r import, echo = FALSE}
load('Labs_БлиновИИ_data.RData')
# Информация по переменной reg.df
#str(reg.df)
```

#### Таблица `r table.num` - описательные статистики модели 1

```{r , echo=FALSE}
# делаем из столбца "FO" фактор
DF$FO <- factor(DF$FO)
# множественная регрессия для всех регионов ====================================
fit.1 <- lm(Ob.ot.t.2017 ~ ind.price.2017 + izm.sr.2017 +ind.phis.2016 + sum.ub.2017, 
            data = reg.df)
kable(round(summary(fit.1)$coef, 4))
table.num <- table.num + 1  

#построим график
par(mfrow = c(1, 2))
plot(Ob.ot.t.2017 ~ ind.price.2017  + sum.ub.2017, 
            data = reg.df)
par(mfrow = c(1, 1))
pic.num <- pic.num + 1


```
#### Рис. `r pic.num`. график разброса начальной модели


**Проверка значимости для коэффициента при sum.ub.2017.**

H0: (параметр) коэфф. при sum.ub.2017 равен 0 в генеральной совокупности (не значим);

H1: (параметр) коэфф. при sum.ub.2017 не равен 0 в генеральной совокупности (значим).

Проверим значимость при помощи p-значения.

 **Параметр не значим.**
 
 **Проведём похожую проверку коэффициента при ind.price.2017.**
 
 P-значение при ind.price.2017 > 0,05 => **Параметр не значим.**
 
 **Проведём похожую проверку коэффициента при ind.price.2017.**

P-значение при ind.price.2017 = $6,8\cdot 10^{-11}=0.4873>\alpha$ => отверается гипотеза H1. **Параметр не значим.**


 ## Модель с переменной структурой по федеральным округам.

Построим модель с переменной структурой, используя принадлежность каждого региона к одному из восьми федеральных округов.
Включим фиктивные переменные как в константу, так и в коэффициенты.
Общий вид модели с переменной структурой.

```{r}
fit.1.fo <- lm(Ob.ot.t.2017 ~ FO*(ind.price.2017 + sum.ub.2017),
            data = reg.df) 
kable(round(summary(fit.1.fo)$coef, 4))
table.num <- table.num + 1
```
Модель в целом незначима, но скорректированный коэффициент
детерминации у неё выше, чем у модели по всем регионам (`r round(summary(fit.1.fo)$r.sq, 3)*100`%). У неё много незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией, которая
проводит процедуру последовательного исключения регрессоров.

Сначала сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой.


### Модель без поправки:


#### Таблица `r table.num` - описательные статистики модели по федеральным округам без поправки

```{r}
X.matrix <- model.matrix(Ob.ot.t.2017 ~ FO*(ind.price.2017 + sum.ub.2017), 
            data = reg.df)
            
            
            # присоединяем независимую переменную
data.fit <- cbind(Ob.ot.t.2017 = reg.df$Ob.ot.t.2017, 
                  data.frame(X.matrix)[, -1])
                  
#сохраняем для следующей лабораторной
data.fit.1.fo <- data.fit

# функция с последовательным исключением незначимых регрессоров
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')

# применяем процедуру, сначала без поправок на p-значения
fit.1.fo <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'Ob.ot.t.2017')
kable(round(summary(fit.1.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.1.fo)
```
Все коэффициенты модели значимы и она имеет высокий уровень коэффициента детерминации. ($R^2 =$ `r round(summary(fit.1.fo)$r.sq, 3)`)
Значимы константы для Приволжского и Уральского федеральных
округов, а также коэффициенты при независимых переменных для некоторых округов. 


### Модель с поправкой Бонферрони:
Явный вид модели : $Ob.ot.t.2017 = 150669,1043 + 15.3600 \cdot sum.ub.2017$.

#### Таблица `r table.num` - описательные статистики модели по федеральным округам с поправкой Бонферрони
```{r}
# теперь с поправкой Бонферрони
fit.1.foB <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'Ob.ot.t.2017',
                                   p.adj.method = 'bonferroni')
kable(round(summary(fit.1.foB)$coef, 4))
table.num <- table.num + 1
```
Коэффициент модели при *FOЦФО.sum.ub.2017* значим, однако коэффициент детерминации заметно понизился ($R^2 =$ `r round(summary(fit.1.foB)$r.sq, 3)`).

## Сравнение моделей по качеству.

Сравним три полученные модели: изначальную, с поправкой по ФО и без поправки по ФО.


#### Таблица `r table.num` - сравнение трёх моделей
```{r}
# модели с фактором sum.ub.2017
#anova(fit.1, fit.1.foB, fit.1.fo)
# список построенных моделей
models.list <- list(fit.1, fit.1.foB, fit.1.fo)
names(models.list) <- c('fit.1', 'fit.1.foBonferroni', 'fit.1.fo')
# фрейм с характеристиками четырёх моделей
df.goodness.of.fit <- data.frame(Модель = names(models.list), 
                                       R.2.скорр = 0,
                                       F.расч = 0,
                                       Станд.Ошибка = 0)
for (i in 1:length(models.list)) {
  # скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.скорр'] <- 
    round(summary(models.list[[i]])$adj.r.squared, 3)
  # F расчётное
  df.goodness.of.fit[i, 'F.расч'] <- 
    round(summary(models.list[[i]])$fstatistic[1], 2)
  # стандартная ошибка
  df.goodness.of.fit[i, 'Станд.Ошибка'] <- 
    round(summary(models.list[[i]])$sigma, 1)
}
kable(df.goodness.of.fit)
table.num <- table.num + 1
mean(reg.df$Ob.ot.t.2017) 
```
Результат: 

Среднее по Y = 466588.5 ;

По столбцу $R^2$ больше всего подходит третья модель;
По столбцу F.расч - первая;
По минимальной Стандартной ошибке - третья.

Таким образом, модель по федеральным округам без поправки (fit.1.fo) наиболее предпочтительна.

**Явный вид модели : $Y.ORTorg.2013 = 150669.1043 - 3351972.8019 \cdot FOПФО + 787362.7268 \cdot FOУФО + 15.3600 \cdot sum.ub.2017 + 36443.2885 \cdot FOПФО.ind.price.2017  - 2329.1439 \cdot FOЦФО.ind.price.2017  -16.2841 \cdot FOПФО.sum.ub.2017 +  23.2109 \cdot FOСЗФО.sum.ub.2017  -19.5927 \cdot FOУФО.sum.ub.2017 +  61.7233 \cdot FOЦФО.sum.ub.2017**


# Раздел II.

## Изначальная регрессионная модель для логарифмированных данных, основанная на Лабораторной №1


#### Таблица `r table.num` - описательные статистики логарифмированной модели 1

```{r}
# множественная регрессия для всех регионов на логарифмированных данных
fit.11 <- lm(Ob.ot.t.2017 ~ ind.price.2017 + sum.ub.2017, 
            data = DF1)
kable(round(summary(fit.11)$coef, 4))  # незначимые параметры
table.num <- table.num + 1
#построим график
par(mfrow = c(1, 2))
plot(Ob.ot.t.2017 ~ ind.price.2017 + sum.ub.2017, 
            data = DF1)
par(mfrow = c(1, 1))
pic.num <- pic.num + 1
```

## Проверка значимости для логарифмированных значений:
**Проверка значимости для коэффициента при ind.price.2017.**
Проверим значимость при помощи p-значения. ( $\alpha = 0,05$ )
P-значение при sum.ub.2017	 = 0.0000<\alpha$ => принимается гипотеза H1. **Параметр значим.**

**Проведём похожую проверку коэффициента при ind.price.2017.**

P-значение при ind.price.2017 = 0,7079<\alpha$ => отвергается гипотеза H1. **Параметр не значим.**

Все имеющиеся параметры значимы, исключать регрессоры не требуется. $R^2 =$ `r round(summary(fit.11)$r.sq, 3)`.

Явный вид модели : $Ob.ot.t.2017 = 3,6101 + 0,6913 \cdot ind.price.2017 + 0,6698\cdot sum.ub.2017$.


## Модель с переменной структурой по федеральным округам (логарифмированные данные).

Построим модель с переменной структурой, используя принадлежность каждого региона к одному из восьми федеральных округов.
Включим фиктивные переменные как в константу, так и в коэффициенты.
Общий вид модели с переменной структурой.

#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам
```{r}
fit.11.fo <- lm(Ob.ot.t.2017 ~ FO*(ind.price.2017 + sum.ub.2017), 
            data = DF1) 
kable(round(summary(fit.11.fo)$coef, 4))
table.num <- table.num + 1
```

Модель в целом незначима, но скорректированный коэффициент
детерминации у неё выше, чем у модели по всем регионам (`r round(summary(fit.11.fo)$r.sq, 3)*100`%). У неё много незначимых параметров.
Исключать их последовательно вручную трудоёмко, поэтому мы воспользуемся пользовательской функцией, которая
проводит процедуру последовательного исключения регрессоров.

Сначала сгенерируем матрицу независимых переменных функцией
*model.matrix()*. После загружаем функцию для исключения незначимых регрессоров
из файла «removeFactorsByPValue.R» в рабочей директории и применяем её
к модели с переменной структурой.


### Модель без поправки:


#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам без поправки
```{r}
# создаём фрейм со всеми переменными-факторами (создаём фиктивные)
X.matrix <- model.matrix(Ob.ot.t.2017 ~ FO*(ind.price.2017 + sum.ub.2017), 
            data = DF1)
# присоединяем независимую переменную
data.fit <- cbind(Ob.ot.t.2017 = DF1$Ob.ot.t.2017, 
                  data.frame(X.matrix)[, -1])
# сохраняем для следующей лабораторной
data.fit.11.fo <- data.fit
# функция с последовательным исключением незначимых регрессоров
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')
# применяем процедуру, сначала без поправок на p-значения
fit.11.fo <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'Ob.ot.t.2017')
kable(round(summary(fit.11.fo)$coef, 4))
table.num <- table.num + 1
#summary(fit.11.fo)
```

Все коэффициенты модели значимы и она имеет высокий уровень коэффициента детерминации. $R^2 =$ `r round(summary(fit.11.fo)$r.sq, 3)`.

*(sum.ub.2017, sum.ub.2017 с Приволжским и Уральским федеральными округами;*
*ind.price с Приволжским и Уральским федеральными округами)*

#### Таблица `r table.num` - описательные статистики логарифмированной модели по федеральным округам с поправкой Бонферрони
```{r}
# теперь с поправкой Бонферрони
fit.11.foB <- removeFactorsByPValue(data = data.fit, 
                                   y.var.name = 'Ob.ot.t.2017',
                                   p.adj.method = 'bonferroni')
kable(round(summary(fit.11.foB)$coef, 4))
table.num <- table.num + 1
```
Коэффициент модели при *sum.ub.2017*, *FOПФО.ind.price.2017*,	*FOПФО.sum.ub.2017* значимы, однако коэффициент детерминации заметно понизился ($R^2 =$ `r round(summary(fit.11.foB)$r.sq, 3)`).

Явный вид модели : $Y.ORTorg.2013 = 8,41 + 0,2581 \cdot KMPred.2013 + 0,1947\cdot RKBS.2012$.

#### Таблица `r table.num` - сравнение трёх моделей
```{r}
# модели с фактором sum.ub.2017
#anova(fit.11, fit.11.foB, fit.11.fo)
# список построенных моделей
models.list <- list(fit.11, fit.11.foB, fit.11.fo)
names(models.list) <- c('fit.11', 'fit.11.foB', 'fit.11.fo')
# фрейм с характеристиками четырёх моделей
df.goodness.of.fit <- data.frame(Модель = names(models.list), 
                                       R.2.скорр = 0,
                                       F.расч = 0,
                                       Станд.Ошибка = 0)
for (i in 1:length(models.list)) {
  # скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.скорр'] <- 
    round(summary(models.list[[i]])$adj.r.squared, 3)
  # F расчётное
  df.goodness.of.fit[i, 'F.расч'] <- 
    round(summary(models.list[[i]])$fstatistic[1], 2)
  # стандартная ошибка
  df.goodness.of.fit[i, 'Станд.Ошибка'] <- 
    round(summary(models.list[[i]])$sigma, 1)
}
kable(df.goodness.of.fit)
table.num <- table.num + 1
mean(reg.df1$Ob.ot.t.2017) 
```


Результат: 

Среднее по Y = 12,07907 ;

По столбцу $R^2$ больше всего подходит третья модель;
По столбцу F.расч - первая;
По минимальной Стандартной ошибке - третья.
Таким образом, модель по федеральным округам (fit.11.fo) наиболее предпочтительна.
**Явный вид модели: Ob.ot.t.2017=5.4440+0.8453 \cdot sum.ub.2017+1.5646 \cdot ind.price.2017+FOПФО.ind.price.2017 \cdot sum.ub.2017 + 1.8097 \cdot ind.price -0.8245\cdot sum.ub.2017 -0.9230  \cdot FOУФО.sum.ub.2017**.

Сохраним нужные данные для дальнейших лабораторных работ.......


```{r}
# 4. Сохранение нужных объектов рабочего пространства  -------------------------
save(list = c('data.fit.1.fo', 'data.fit.11.fo', 'fit.1.fo', 'fit.11.fo', 'DF', 'DF1', 'reg.df'), 
    file = 'test_lab2_Блинов.RData')
```









